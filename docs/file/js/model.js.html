<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">js/model.js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/model.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const Model = function() {
  console.log(&quot;Initializing Model&quot;);
  this.initialize_state();
  this.move_generator = new MoveGenerator(this);
  this.view           = new View(this);   
  
  window.model = this;   
};


Model.prototype.each_child = function(depth) {
  if (depth === 0) {
    return;
  }
  let legal_moves = this.move_generator.legal_moves();
  legal_moves.forEach((move) =&gt; {
    if (move !== this.last_uncommitted_dst()) {
      this.push_uncommitted_move(move);
      if (!this.is_first_piece_destination()) {
        console.log(this._state.uncommitted_move);  /// &lt;--- this should be a yield.  
      }
      this.each_child(depth - 1);
      this.pop_uncommitted_move();      
    }
  });
  
};

Model.prototype.handle_first_human_move = function(i) {
  if (this.square(i) !== this.human_team()) {
    this.set_error(&quot;You must start with one of your pieces&quot;);
    this.view.draw();
    return;
  }

  this._state.uncommitted_move.push(i);

  let moves = this.move_generator.legal_moves();

  if (moves.length === 0) {
    if (this.is_first_turn()) {
      this.set_error(&quot;Your first move must be a sliding move&quot;);                
    } else {
      this.set_error(&quot;This piece has no moves&quot;);          
    }
    this._state.uncommitted_move.pop(i);

  }
  
  this.view.draw();
  return;      
};


Model.prototype.handle_nth_human_move = function(dst) {
  let src = this.last_uncommitted_dst();
  if (this.move_generator.is_legal_piece_move(src, dst)) {
    this.push_uncommitted_move(dst);
  } else if (this.is_first_piece_destination() &amp;&amp; this.square(dst) == this.human_team()) { // They want to start with a different sq.
    this._state.uncommitted_move.pop();
    this._state.uncommitted_move.push(dst);

  } else {
    this.set_error(&quot;Not a legal move&quot;);
  }
  
  this.view.draw();
};

Model.prototype.handle_human_uncommitted_undo = function() {
  if (!this.is_human_turn()) {
    this.set_error(&quot;It&apos;s not your turn!&quot;);
    return;
  }
  
  if (this.is_start_of_turn()) {
    this.set_error(&quot;Nothing to take back&quot;);
    this.view.draw();
    return;
  }
  this.pop_uncommitted_move();
  if (this.is_first_piece_destination()) {
    this._state.uncommitted_move.pop();
  }
  this.view.draw();
  
};


Model.prototype.add_to_human_move = function(i) {
  if (!this.is_human_turn()) {
    alert(&quot;Its not your turn&quot;);
    return;
  }
      
  if (this.is_start_of_turn()) {
    this.handle_first_human_move(i);
  } else {
    this.handle_nth_human_move(i);
  }
  return;
};

Model.prototype.make_computer_move = function() {
  let moves, r;
  
  while(true) {
    moves = this.move_generator.legal_moves();
    r = Math.floor(Math.random()*(moves.length));
    this.push_uncommitted_move(moves[r]);
    moves = this.move_generator.legal_moves();
    if (moves.length &gt; 0) {
      break;
    }
    this.pop_uncommitted_move();    
  }
  r = Math.floor(Math.random()*(moves.length));
  this.push_uncommitted_move(moves[r]);

  this.push_move();
  this.view.draw();  
};

Model.prototype.human_commit_move = function() {
  let move = this.uncommitted_move();
  if (move.length &lt; 2) {
    this.set_error(&quot;You need to make a move first&quot;);
    this.view.draw();
    return;
  }
  
  this.push_move();
  this.make_computer_move();
};


Model.prototype.is_uncommitted_slide = function() {
  if (this._state.uncommitted_move.length === 2) {
    return(this.move_generator.is_slide_move(this._state.uncommitted_move[0],
                                             this._state.uncommitted_move[1]));
  }
  return(false);
}

Model.prototype.winner = function() {
  if (this.is_first_turn()) {
    return(0);
  }
  // This should be O(1) via memoization, currently O(n)..

  counts = [0, 0, 0];
  
  this.court_squares.forEach((i)=&gt; {
    counts[this.square(i)] += 1;    
  });
  
  if (counts[1] == 0) {
    return(2);
  }
  if (counts[2] == 0) {
    return(1);
  }
  
  return(0);

};


Model.prototype.push_uncommitted_move = function(dst) {
  let src = this.last_uncommitted_dst();
  if (src !== undefined) {
    this.move_piece(src, dst);    
  }

  if (this.move_generator.is_jump_move(src,dst)) {
    let jumped = this.move_generator.jumped_square(src,dst);
    if (this.is_enemy(jumped)) {
      this._state.uncommitted_move.push(-1);
      this.set_square(jumped, 0);          
    }
  }
  this._state.uncommitted_move.push(dst);  
};

Model.prototype.pop_uncommitted_move = function() {
  let last_dst = this._state.uncommitted_move.pop();
  let enemy_jump_move = false;

  if (last_dst === undefined) {
    console.log(&quot;Warning: tried to pop empty uncommitted move&quot;);
    return;
  }

  if (this.is_start_of_turn()) {
    return;
  }

  if (this.last_uncommitted_dst() === -1) {
    this._state.uncommitted_move.pop();
    enemy_jump_move = true;    
  }
  
  let last_src = this.last_uncommitted_dst();

  if (last_src !== undefined) {
    this.move_piece(last_dst, last_src);
    if (this.move_generator.is_jump_move(last_dst,last_src) &amp;&amp; enemy_jump_move) {
      let jumped = this.move_generator.jumped_square(last_dst,last_src);
      this.set_square(jumped, this.other_team());          
    }    
  }
    
};

Model.prototype.push_move = function() {

  this._state.committed_moves.push(this._state.uncommitted_move.slice(0));
  this._state.uncommitted_move = [];
  this._state.turn = this.other_team();
  this.view.draw();
};

Model.prototype.pop_move = function() {
  this._state.turn = this.other_team();
  this._state.uncommitted_move = this._state.committed_moves.pop();

  while(!this.is_start_of_turn()) {
    this.pop_uncommitted_move();
  }
  this.view.draw();
    
};

Model.prototype.fetch_and_clear_error_message = function() {
  let err = this._state.error_message;
  this._state.error_message = null;                                  
  return(err);
};


Model.prototype.move_piece = function(src,dst) {
  this.set_square(dst, this.square(src));    
  this.set_square(src, 0);  
};


// Primatives.

Model.prototype.is_start_of_turn = function() {
  return(this._state.uncommitted_move.length === 0);  
};

Model.prototype.is_first_piece_destination = function() {
  return(this._state.uncommitted_move.length === 1);  
};

Model.prototype.is_court_square = function(i) {
  return this.court_square_map[i];
};

Model.prototype.is_first_turn = function() {
  return(this._state.committed_moves.length &lt; 2);
};

Model.prototype.is_enemy = function(i) {
  return this.square(i) == this.other_team();  
};

Model.prototype.is_empty = function(i) {
  return this.square(i) === 0;
};

Model.prototype.is_human_turn = function() {
  return(this.turn() === this.human_team());
};

Model.prototype.uncommitted_move = function() {
  return(this._state.uncommitted_move);
};


Model.prototype.last_uncommitted_dst = function() {
  return(this._state.uncommitted_move[this._state.uncommitted_move.length - 1]);
};

Model.prototype.other_team = function() {
  return this.turn() == 1 ? 2 : 1;  
};

Model.prototype.set_error = function(msg) {
  this._state.error_message = msg;
};

Model.prototype.human_team = function() {
  return(this._state.human_team);  
};

Model.prototype.turn = function() {
  return(this._state.turn);
};

Model.prototype.set_square = function(i, val) {
  this._state.squares[i] = val;  
};

Model.prototype.square = function(i) {
  return this._state.squares[i];  
};


Model.prototype.initialize_state = function() {
  this._state                  = {};
  this._state.moves            = [];
  this._state.human_team       = 1;
  this._state.turn             = 1;
  this._state.uncommitted_move = [];
  this._state.committed_moves  = [];
  this._state.error_message    = null;
  this._state.squares          = [ 1, 2, 1, 2, 1, 2, 1, 2,
                                   2, 1, 2, 1, 2, 1, 2, 1, 
                                   1, 2, 0, 0, 0, 0, 1, 2,
                                   2, 1, 0, 0, 0, 0, 2, 1, 
                                   1, 2, 0, 0, 0, 0, 1, 2,
                                   2, 1, 0, 0, 0, 0, 2, 1, 
                                   1, 2, 1, 2, 1, 2, 1, 2,
                                   2, 1, 2, 1, 2, 1, 2, 1,     
                                 ];  
                                
  // DEBUG MODE
  //this.set_square(19, 1);
  //this.set_square(27, 2);
  //this.set_square(26, 2);

};

Model.prototype.court_squares    = [18,19,20,21,26,27,28,29,34,35,36,37,42,43,44,45];
Model.prototype.court_square_map = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
